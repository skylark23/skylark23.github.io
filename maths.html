function doPost(e) {
  try {
    const studentsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Students");
    const clicksSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Clicks");
    const action = e?.parameter?.action;
    const sid = (e?.parameter?.sid || "").replace(/-/g, "");
    
    // Handle getAllRecords action
    if (action === "getAllRecords") {
      const studentName = lookupStudent(studentsSheet, sid);
      
      if (!studentName) {
        return ContentService
          .createTextOutput(JSON.stringify({ error: "Student not found" }))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      const showDeleted = e?.parameter?.showDeleted === "true";
      const records = getAllRecordsForStudent(clicksSheet, studentName, showDeleted);
      return ContentService
        .createTextOutput(JSON.stringify({ records: records, studentName: studentName }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Handle softDelete action
    if (action === "softDelete") {
      const rowNum = parseInt(e?.parameter?.rowNum);
      if (rowNum && rowNum > 0) {
        clicksSheet.getRange(rowNum, 5).setValue("deleted"); // Column E (index 5)
        return ContentService
          .createTextOutput(JSON.stringify({ success: true }))
          .setMimeType(ContentService.MimeType.JSON);
      }
      return ContentService
        .createTextOutput(JSON.stringify({ error: "Invalid row number" }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Handle undoDelete action
    if (action === "undoDelete") {
      const rowNum = parseInt(e?.parameter?.rowNum);
      if (rowNum && rowNum > 0) {
        clicksSheet.getRange(rowNum, 5).setValue(""); // Clear status
        return ContentService
          .createTextOutput(JSON.stringify({ success: true }))
          .setMimeType(ContentService.MimeType.JSON);
      }
      return ContentService
        .createTextOutput(JSON.stringify({ error: "Invalid row number" }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Handle getLast action
    if (action === "getLast") {
      const studentName = lookupStudent(studentsSheet, sid);
      
      if (!studentName) {
        return ContentService
          .createTextOutput(JSON.stringify({ error: "Student not found" }))
          .setMimeType(ContentService.MimeType.JSON);
      }

      const rowNum = findLastRowForStudent(clicksSheet, studentName);
      const response = rowNum
        ? { 
            empty: false, 
            estTime: clicksSheet.getRange(rowNum, 1).getValue(),
            studentName: studentName
          }
        : { empty: true };
      
      return ContentService
        .createTextOutput(JSON.stringify(response))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Original doPost logic for logging clicks
    const now = new Date();
    const est = Utilities.formatDate(now, "America/New_York", "yyyy-MM-dd hh:mm:ss a");
    const ist = Utilities.formatDate(now, "Asia/Kolkata", "yyyy-MM-dd hh:mm:ss a");
    const ip = e?.parameter?.ip || "unknown";
    
    const studentName = lookupStudent(studentsSheet, sid);
    // Add empty status (active record)
    clicksSheet.appendRow([est, ist, ip, studentName || "Unknown", ""]);

    return ContentService
      .createTextOutput(JSON.stringify({ status: "success" }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log("Error in doPost: " + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({ error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function lookupStudent(studentsSheet, guid) {
  const data = studentsSheet.getDataRange().getValues();
  const searchGuid = String(guid).trim();
  
  for (let i = 1; i < data.length; i++) {
    const cellGuid = String(data[i][0]).trim();
    if (cellGuid === searchGuid) {
      return data[i][1];
    }
  }
  return null;
}

function findLastRowForStudent(clicksSheet, studentName) {
  const data = clicksSheet.getDataRange().getValues();
  const searchName = String(studentName).trim();
  
  for (let i = data.length - 1; i > 0; i--) {
    const cellName = String(data[i][3]).trim();
    const status = String(data[i][4] || "").trim();
    // Only return active records (not deleted)
    if (cellName === searchName && status !== "deleted") {
      return i + 1;
    }
  }
  return null;
}

function getAllRecordsForStudent(clicksSheet, studentName, showDeleted) {
  const data = clicksSheet.getDataRange().getValues();
  const searchName = String(studentName).trim();
  const records = [];
  
  // Start from row 1 to skip header
  for (let i = 1; i < data.length; i++) {
    const cellName = String(data[i][3]).trim();
    const status = String(data[i][4] || "").trim();
    
    if (cellName === searchName) {
      // If showDeleted is false, skip deleted records
      if (!showDeleted && status === "deleted") {
        continue;
      }
      
      records.push({
        rowNum: i + 1, // Store actual row number for delete/undo
        estTime: data[i][0],
        istTime: data[i][1],
        website: data[i][2],
        status: status || "active"
      });
    }
  }
  
  // Return in descending order (most recent first)
  return records.reverse();
}
